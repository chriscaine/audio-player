<!doctype html>
<html ng-app="app">
<head>
    <title>Socket.IO Position</title>
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <meta name="viewport" value="width=device-width;initial-scale=1" />
    <style type="text/css">
        * {
            user-select: none;
        }

        li {
            cursor: pointer;
        }

        .playlist li {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
        }

    
    </style>
</head>
<body class="" style="">

    <div class="header">

        <div class="controls ">
            <button class="transport-control btn btn-success glyphicon glyphicon-play" type="button" data-type="PLAY"></button>
            <button class="transport-control btn btn-default glyphicon glyphicon-pause" type="button" data-type="PAUSE"></button>
            <button class="transport-control btn btn-warning glyphicon glyphicon-stop" type="button" data-type="STOP"></button>
            <button class="transport-control btn btn-warning glyphicon glyphicon-stop" type="button" data-type="STOPAFTER"></button>
	    <span id="now-playing"></span>
        </div>

    </div>
    <div class="lists">
        <div class="container-fluid">
            <div class="row">


                <div class="col-xs-6">
                    <div class="well">
                        <div class="input-group">
                            <input id="txtSearch" class="form-control" type="text" ng-model="search" placeholder="Search for tracks..." />
                            <span class="input-group-btn">
                                <button id="btnSearch" class="btn btn-default" type="button" value="Search">
                                    <span class="glyphicon glyphicon-search"></span>
                                </button>
                            </span>
                        </div><!-- /input-group -->
                    </div><!-- /well -->
                    <div class="">
                        <ul id="tracks" class="tracks sortable list-group"></ul>
                    </div>
                </div>
                <div class="col-xs-6">
                    <h2>Playlist</h2>
                    <div class="playlist-box">
                        <ul id="playlist" class="playlist list-group"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/lib/jquery-1.7.1.min.js"></script>
    <script src="js/lib/rx.all.min.js"></script>
    <script src="js/lib/Sortable.js"></script>
    <script src="http://192.168.1.11:8080/socket.io/socket.io.js"></script>
    <script>
        var socket = io.connect('http://192.168.1.11:8080/');
        var transportClick = function (e) {
            console.log(e);
            socket.emit('transport', e.target.dataset);
        }
        var CTRLS = {
            PLAY: 'PLAY',
            PAUSE: 'PAUSE',
            STOP: 'STOP',
            STOPAFTER: 'STOPAFTER'
        }

        var Playlist = function (element) {
            var _this = this;
            this.El = element;
            this.Items = [];
            this.Fill = function (playlist) {
                while (this.Items.length > 0) this.Items.pop();
                var max = playlist.length;
                for (var i = 0; i < max; i += 1) {
                    this.Items.push(playlist[i]);
                }
            }
            this.GetElement = function (track) {
                var button = $('<button />', { 'class': 'btn btn-success transport-control', 'data-id': track.id, 'data-type': CTRLS.PLAY });
                button.append($('<span />', { 'class': 'glyphicon glyphicon-play' }));
                button.on('click', transportClick)
                return $('<li />', { 'class': 'list-group-item', 'data-id': track.id })
                            .append($('<span />').html(track.title))
                            .append(button);
            }

            this.Draw = function (tracks) {
                this.El.empty();
                var max = this.Items.length;
                for (var i = 0; i < max; i += 1) {
                    this.El.append(this.GetElement(tracks[this.Items[i]]));
                }
            }
            this.Sync = function () {
                console.log(this, _this);
                socket.emit('playlist:sync', _this.Items);
            }
        }

        var Tracks = function () {
            this.Items = {};
            this.Fill = function (data) {
                for (var key in data) {
                    this.Items[key] = data[key];
                }
            }
            this.FillFromArray = function (arr) {
                var max = arr.length;
                for (var i = 0; i < max; i += 1) {
                    this.Items[arr[i].id] = arr[i];
                }
            }
            this.GetElement = function (track) {
                return $('<li />', { 'data-id': track.id, 'class': 'sortable list-group-item' })
                            .text(track.title);
            }
            this.Draw = function (element, result) {
                var max = result.length;
                element.empty();
                for (var i = 0; i < max; i += 1) {
                    element.append(this.GetElement(result[i]));
                }
            }
        };
        var playlist = new Playlist($('#playlist'));
        var tracks = new Tracks();

        var syncRequest$ = new Rx.Subject();
        syncRequest$.throttle(2000).subscribe(playlist.Sync);

        var searchRequest$ = Rx.Observable.fromEvent($('#txtSearch'), 'input')
				.map(function (e) { return e.target.value; })
				.filter(function(e) { return e.length > 2;})
				.throttle(300);
        var transport$ = Rx.Observable.fromEvent($('.transport-control'), 'click');

        var sortables = [];


        transport$.subscribe(transportClick);
	socket.on('transport:now-playing', function(track) {
		$('#now-playing').text(track.title + ' by ' + track.artist[0]);
	});

        $('ul.tracks').each(function (index, item) {
            var sortable = new Sortable(item, {
                group: {
                    name: 'sortable',
                    pull: 'clone',
                    put: false
                }
            });
            sortables.push(sortable);
        });

        $('ul.playlist').each(function (index, item) {
            var sortable = new Sortable(item, {
                group: 'sortable',
                //handle: '.drag-handle',
                onAdd: function (evt) {
                    var id = evt.item.dataset.id;
                    if (id && id.length === 36) {

                        var track = tracks.Items[id];
                        console.log(tracks, id);
                        if (track) {


                            $(evt.target).append(playlist.GetElement(track));
                            $(evt.item).remove();
                            var _playlist = [];
                            $('ul.playlist li').each(function (index, item) {
                                _playlist.push(item.dataset.id);
                            });

                            playlist.Fill(_playlist);
                            syncRequest$.onNext(true);
                        } else {
                            throw "Found no track data";
                        }
                    }
                },
                onUpdate: function () {
                    var _playlist = [];
                    $('ul.playlist li').each(function (index, item) {
                        _playlist.push(item.dataset.id);
                    });

                    playlist.Fill(_playlist);
                    syncRequest$.onNext(true);
                }
            });
            console.log(sortable);
            sortables.push(sortable);
        });


        searchRequest$.subscribe(function (value) {
            socket.emit('search:query', ['title', value]);
        });

        socket.on('playlist:load', function (data) {
            tracks.Fill(data.Tracks);
            playlist.Fill(data.Playlist);
            playlist.Draw(tracks.Items);
        });

        socket.on('search:result', function (data) {
            tracks.Draw($('#tracks'), data.result);
            tracks.FillFromArray(data.result);
        });

    </script>
</body>
</html>