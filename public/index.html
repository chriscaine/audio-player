<!doctype html>
<html ng-app="app">
<head>
    <title>Socket.IO Position</title>
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <meta name="viewport" value="width=device-width;initial-scale=1" />
    <style type="text/css">
        * {
            user-select: none;
        }
        .header {
            height:12vh;
        }
        .well.well {
            min-height:unset;
            padding:0 20px 0 20px;
            margin:0 20px 0 20px;
        }
        ul {
            height: 85vh;
            overflow:auto;
            background-color: #e7e7e7;
            border: solid 1px #e5e5e5;
            border-radius: 3px;
        }

        li.list-group-item.list-group-item {
            cursor: pointer;
            display: flex;
            flex-direction: row;
            justify-content: flex-end;
        }

        li .track-label {
            align-self: center;
            flex-basis: 100%;
        }


        .btn-wrapper {
            padding-left: 5px;
        }

        .playing {
            display: none;
        }

        .tracks .btn {
            display: none;
        }

        .now-playing .playing {
            display: block;
        }

        .now-playing .play {
            display: none;
        }
    </style>
</head>
<body class="" style="">

    <div class="header">
   <div class="well">
        <div class="controls ">
            <button class="transport-control btn btn-success glyphicon glyphicon-play" type="button" data-type="PLAY"></button>
            <button class="transport-control btn btn-default glyphicon glyphicon-pause" type="button" data-type="PAUSE"></button>
            <button class="transport-control btn btn-warning glyphicon glyphicon-stop" type="button" data-type="STOP"></button>
            <button class="transport-control btn btn-warning glyphicon glyphicon-stop" type="button" title="Stop playlist at end of track" data-type="STOPAFTER"></button>

            <span class="btn btn-default" id="now-playing"></span>
            <button class="btn btn-danger glyphicon glyphicon-off pull-right" title="Shutdown System" type="button" data-type="SHUTDOWN"></button> 
             <button class="btn btn-alert glyphicon glyphicon-trash pull-right" title="Empty Playlist" type="button" data-type="REMOVE"></button>
           
        </div>
       <br/>
            <div class="input-group">
                <input id="txtSearch" class="form-control" type="text" ng-model="search" placeholder="Search for tracks..." />
                <span class="input-group-btn">
                    <button id="btnSearch" class="btn btn-default glyphicon glyphicon-search" type="button" value="Search"></button>
                </span>
            </div>
            <!-- /input-group -->
        </div>
    <!-- /well -->
    </div>
    <div class="lists">
        <div class="container-fluid">
            <div class="row">
                <div class="col-xs-6">
                    <div class="">
                        <ul id="tracks" class="tracks sortable list-group"></ul>
                    </div>
                </div>
                <div class="col-xs-6">
                    <div class="playlist-box">
                        <ul id="playlist" class="playlist list-group"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script id="track" type="text/template">
        <li class="list-group-item" data-id="{{id}}">
            <div class="track-label">{{title}} by {{ artist }}<br />
               <em>{{album}} (Year {{year}} Track {{track.no}} of {{track.of}})</em></div>
            <span class="btn-wrapper">
                <button data-type="REMOVE"
                    data-id="{{id}}"
                    class="btn btn-default glyphicon glyphicon-trash">
                </button>
            </span>
            <span class="playing btn glyphicon glyphicon-play-circle" style="color: green;"></span>
            <span class="play btn-wrapper">
                <button data-type="PLAY"
                    data-id="{{id}}"
                    class="btn btn-success transport-control glyphicon glyphicon-play">
                </button>
            </span>
        </li>
    </script>

    <script src="js/lib/mustache.min.js"></script>
    <script src="js/lib/jquery-1.7.1.min.js"></script>
    <script src="js/lib/rx.all.min.js"></script>
    <script src="js/lib/Sortable.js"></script>
    <script src="http://localhost:8080/socket.io/socket.io.js"></script>
<script>

        var View = function (template) {
            var template = $('#' + template).html();
            Mustache.parse(template);   // optional, speeds up future uses
            this.Render = function (model) {
                return Mustache.render(template, model);
            }
        }

        var trackItemView = new View('track');

        var socket = io.connect('http://localhost:8080/');
        var CTRLS = {
            PLAY: 'PLAY',
            PAUSE: 'PAUSE',
            STOP: 'STOP',
            STOPAFTER: 'STOPAFTER',
            REMOVE: 'REMOVE',
            SHUTDOWN : 'SHUTDOWN'
        }

        var Utilities = {
            ByTag: function ByTag(tag) {
                var _tag = tag;
                return function (e) {
                    return e.target.tagName === tag.toUpperCase();
                }
            },
            ByDataType: function byDataType(type, not) {
                var _type = type;
                var invert = not === true;
                return function (data) {
                    if (invert) {
                        return !data.type === _type;
                    } else {
                        return data.type === _type;
                    }
                }
            }
        }

        

        

        var Playlist = function (element) {
            var _this = this;
            this.El = element;
            this.Items = [];
            this.Fill = function (playlist) {
                while (this.Items.length > 0) this.Items.pop();
                var max = playlist.length;
                for (var i = 0; i < max; i += 1) {
                    this.Items.push(playlist[i]);
                }
            }
            this.NowPlaying = function (id) {
                this.El.find('li').removeClass('now-playing').each(function (i, item) {
                    if ($(item).attr('data-id') === id) $(item).addClass('now-playing');
                });
            }

            this.Draw = function (tracks) {
                _this.El.empty();
                var max = _this.Items.length;
                for (var i = 0; i < max; i += 1) {
                    // this.El.append(this.GetElement(tracks[this.Items[i]]));
                    _this.El.append(trackItemView.Render(tracks[_this.Items[i]]));
                }
            }
            this.Remove = function (id) {
                if (id) {
                    var index = _this.Items.indexOf(id);
                    if (index > -1) {
                        _this.Items.splice(index, 1);
                    }
                } else {
                    if (confirm('Are you sure you want to empty the playlist?')) {
                        while (_this.Items.length) _this.Items.pop();
                    }
                }
            }
            this.Sync = function () {
                console.log(this, _this);
                socket.emit('playlist:sync', _this.Items);
            }
            this.Update = function () {
                // update playlist from view
                throw "Not Implimented";
            }
        }

        var Tracks = function () {
            this.Items = {};
            this.Fill = function (data) {
                for (var key in data) {
                    this.Items[key] = data[key];
                }
            }
            this.FillFromArray = function (arr) {
                var max = arr.length;
                for (var i = 0; i < max; i += 1) {
                    this.Items[arr[i].id] = arr[i];
                }
            }
            this.GetElement = function (track) {
                return $('<li />', { 'data-id': track.id, 'class': 'sortable list-group-item' }).text(track.title);
            }
            this.Draw = function (element, result) {
                var max = result.length;
                element.empty();
                for (var i = 0; i < max; i += 1) {
                    element.append(trackItemView.Render(result[i]));
                }
            }
        };

        var playlist = new Playlist($('#playlist'));
        var tracks = new Tracks();

        var syncRequest$ = new Rx.Subject();
        syncRequest$.throttle(2000).subscribe(playlist.Sync);

        var searchRequest$ = Rx.Observable.fromEvent($('#txtSearch'), 'input')
				.map(function (e) { return e.target.value; })
				.filter(function (e) { return e.length > 2; })
				.debounce(300);


        var allClickEvents$ = Rx.Observable.fromEvent(document.body, 'click').filter(Utilities.ByTag('button')).map(function (e) { return e.target.dataset; });

        var transport$ = allClickEvents$.filter(Utilities.ByDataType(CTRLS.REMOVE, true));

        var removeItemClick$ = allClickEvents$.filter(Utilities.ByDataType(CTRLS.REMOVE));
        removeItemClick$.subscribe(function (data) {
            playlist.Remove(data.id);
            playlist.Draw(tracks.Items);
            playlist.Sync();
        });

        transport$.subscribe(function (data) {  socket.emit('transport', data); });

        var sortables = [];
        $('ul.tracks').each(function (index, item) {
            var sortable = new Sortable(item, {
                group: {
                    name: 'sortable',
                    pull: 'clone',
                    put: false
                }
            });
            sortables.push(sortable);
        });

        $('ul.playlist').each(function (index, item) {
            var sortable = new Sortable(item, {
                group: 'sortable',
                //handle: '.drag-handle',
                onAdd: function (evt) {
                    var _playlist = [];
                    $('ul.playlist li').each(function (index, item) {
                        _playlist.push(item.dataset.id);
                    });

                    playlist.Fill(_playlist);
                    syncRequest$.onNext(true);
                },
                onUpdate: function () {
                    var _playlist = [];
                    $('ul.playlist li').each(function (index, item) {
                        _playlist.push(item.dataset.id);
                    });

                    playlist.Fill(_playlist);
                    syncRequest$.onNext(true);
                }
            });
            console.log(sortable);
            sortables.push(sortable);
        });

        searchRequest$.subscribe(function (value) {
            console.log(value);
            socket.emit('search:query', value);// ['title', value]);
        });

        socket.on('transport:now-playing', function (track) {
            if (track) {
                $('#now-playing').text(track.title + ' by ' + track.artist[0]);
                playlist.NowPlaying(track.id);
            }
        });

        socket.on('playlist:load', function (data) {
            tracks.Fill(data.Tracks);
            playlist.Fill(data.Playlist);
            playlist.Draw(tracks.Items);
        });

        socket.on('search:result', function (data) {
            tracks.Draw($('#tracks'), data.result);
            tracks.FillFromArray(data.result);
        });

    </script>
</body>
</html>
