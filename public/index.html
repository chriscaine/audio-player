<!doctype html>
<html ng-app="app">
<head>
    <title>Socket.IO Position</title>
    <meta name="viewport" value="width=device-width;initial-scale=1" />
    <style type="text/css">
        body, :root {
            font-size: 10px;
            background: #e9e9e9;
        }
        .container{
            display:flex;
            flex-direction:row;
        }
        .playlist-container, .search-container{
            flex-shrink:0;
            flex-basis: 300px;
            flex-grow:1;
        }
        

        h1, h2 {
            font-family: sans-serif;
            font-size: 18px;
            margin: 0 0 12px 0;
            color: #555;
        }

        .container {
            margin: 20px;
            font-size: 0;
        }

        .search-box {
            display: block;
            width: auto;
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            vertical-align: top;
            font-size: 1.4rem;
        }

        .playlist-box {
            display: block;
            width: auto;
            vertical-align: top;
            background: #666;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            font-size: 1.4rem;
        }

        ul {
            min-height: 40px;
            width: auto;
            margin:10px 10px 30px 10px;
            padding:0;
            list-style:none;
        }
        li {
            background:#f5f5f5;
            font-size:1.6rem;
            line-height:1.4em;
            padding:0.5em;
            border-radius:3px;
            border: solid 1px #e5e5e5;
            cursor:pointer;
            margin-bottom:5px;
        }
    </style>
</head>
<body>
    <h1>Audio-Player</h1>



<div ng-controller="HomeController">
    <div>
    <div class="controls">
        <input class="transport-control" type="button" value="{{CTRLS.PLAY}}" data-id="1" />
        <input class="transport-control" type="button" value="{{CTRLS.PAUSE}}" />
        <input class="transport-control" type="button" value="{{CTRLS.STOP}}" />
        <input class="transport-control" type="button" value="{{CTRLS.STOPAFTER}}" />
    </div>
    <div class="container">


        <div class="search-container">

            <input type="text" ng-model="search"/>
            <input type="button" value="Search" ng-click="searchClick()"/>
            <div class="">
                <div class="search-box">
                    <ul class="tracks sortable">
                        <li data-id="{{a.id}}" class="sortable" ng-repeat="a in results[0]">
                            <span>{{a.name}}</span>
                        </li>
                    </ul>
                    <ul class="tracks sortable">
                        <li data-id="{{a.id}}" class="sortable" ng-repeat="a in results[1]">
                            <span>{{a.name}}</span>
                        </li>
                    </ul>
                    <ul class="tracks sortable">
                        <li data-id="{{a.id}}" class="sortable" ng-repeat="a in results[2]">
                            <span>{{a.title}}</span>
                        </li>
                    </ul>
                </div>
            </div>

        </div>


         <div class="playlist-container">
                <div class="playlist-box">
                    <ul class="playlist"></ul>
                </div>
            </div>
    </div>
</div>


</div>

    <script src="js/lib/jquery-1.7.1.min.js"></script>
    <script src="js/lib/rx.all.min.js"></script>
    <script src="js/lib/Sortable.js"></script>
    <script src="js/lib/angular-1-1-5.min.js"></script>
    <script src="js/lib/rx.angular.min.js"></script>
    <script>
        angular.module('core', []);
    </script>
    <script src="http://localhost:8080/socket.io/socket.io.js"></script>
<script>
        var app = angular.module('app', ['core', 'rx']);
        var socket = io.connect('http://localhost:8080/');
    
     

        app.controller('HomeController', function ($scope, $timeout) {
            var sortables = [];
            
            $scope.CTRLS = {
                PLAY: 'PLAY',
                PAUSE:'PAUSE',
                STOP: 'STOP',
                STOPAFTER: 'STOPAFTER'
            }
            
            var transport$ = Rx.Observable.fromEvent($('.transport-control'), 'click').map(function (e) {
                return { type: e.target.value, data : e.target.dataset };
            });;
          
            transport$.subscribe(function (e) {
         
             socket.emit('transport', e);
            })


            $('ul.tracks').each(function (index, item) {
                var sortable = new Sortable(item, {
                    group: {
                        name: 'sortable',
                        pull: 'clone',
                        put: false
                    }
                });
                sortables.push(sortable);
            });

            $('ul.playlist').each(function (index, item) {
                var sortable = new Sortable(item, {
                    group: 'sortable',
                    //handle: '.drag-handle',
                    onAdd: function (evt) {
                        // if data id is array then create a set of items at position 
                        // sync and 
                        // thus get associated track data
                        
                        $(evt.item).remove();
                        $(evt.target).append(evt.item);
                        var playlist = [];
                        $('ul.playlist li').each(function (index, item) {
                              playlist.push(item.dataset.id);
                        });
                        
                        socket.emit('playlist:sync', playlist);

                    }
                });
                console.log(sortable);
                sortables.push(sortable);
            });
            $scope.searchClick = function () {
                socket.emit('search:query', ['title', $scope.search]);

            }

            var first = true;
            $scope.$watch('search', function (n, o, e) {
                if (n) socket.emit('search:query', n);
            });

            socket.on('search:result', function (data) {
                console.log(data);
                $timeout(function () {
                    //  ====>
                    /*
                     *  Need to write a module to draw lists
                     *
                     */
                    $scope.results = data.result;
                });
            });
        });

    </script>
</body>
</html>