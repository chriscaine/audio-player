<!doctype html>
<html ng-app="app">
<head>
    <title>Socket.IO Position</title>
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <meta name="viewport" value="width=device-width;initial-scale=1" />
    <style type="text/css">
        * {
            user-select: none;
        }

        li.list-group-item.list-group-item {
            cursor: pointer;
            display: flex;
            flex-direction: row;
            justify-content: flex-end;
        }

            li .track-label {
                align-self: center;
                flex-basis: 100%;
            }

            li button {
            }
            .playing {
                display:none;
            }
        

        .now-playing .playing {
            display:block;
        }
        .now-playing .play {
            display:none;
        }
    </style>
</head>
<body class="" style="">

    <div class="header">

        <div class="controls ">
            <button class="transport-control btn btn-success glyphicon glyphicon-play" type="button" data-type="PLAY"></button>
            <button class="transport-control btn btn-default glyphicon glyphicon-pause" type="button" data-type="PAUSE"></button>
            <button class="transport-control btn btn-warning glyphicon glyphicon-stop" type="button" data-type="STOP"></button>
            <button class="transport-control btn btn-warning glyphicon glyphicon-stop" type="button" data-type="STOPAFTER"></button>
            <span id="now-playing"></span>
        </div>

    </div>
    <div class="lists">
        <div class="container-fluid">
            <div class="row">


                <div class="col-xs-6">
                    <div class="well">
                        <div class="input-group">
                            <input id="txtSearch" class="form-control" type="text" ng-model="search" placeholder="Search for tracks..." />
                            <span class="input-group-btn">
                                <button id="btnSearch" class="btn btn-default" type="button" value="Search">
                                    <span class="glyphicon glyphicon-search"></span>
                                </button>
                            </span>
                        </div><!-- /input-group -->
                    </div><!-- /well -->
                    <div class="">
                        <ul id="tracks" class="tracks sortable list-group"></ul>
                    </div>
                </div>
                <div class="col-xs-6">
                    <h2>Playlist</h2>
                    <div class="playlist-box">
                        <ul id="playlist" class="playlist list-group"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script id="track" type="text/template">
        <li class="list-group-item" data-id="{{id}}">
            <div class="track-label">{{title}} by {{ artist }}<br />Year {{year}} Track {{track.no}} of {{track.of}}</div>
            <span>
                <button class="btn btn-default">
                    <span class="glyphicon glyphicon-trash"></span>
                </button>
            </span>
            <span class="playing glyphicon glyphicon-play-circle" style="color:green;"></span>
            <span class="play">
                <button class="btn btn-success transport-control"
                        data-id="{{id}}"
                        data-type="PLAY">
                   
                    <span class="glyphicon glyphicon-play"></span>
                </button>
            </span>
        </li>
    </script>

    <script src="js/lib/mustache.min.js"></script>
    <script src="js/lib/jquery-1.7.1.min.js"></script>
    <script src="js/lib/rx.all.min.js"></script>
    <script src="js/lib/Sortable.js"></script>
    <script src="http://192.168.1.11:8080/socket.io/socket.io.js"></script>
    <script>

        var View = function (template) {
            var template = $('#' + template).html();
            Mustache.parse(template);   // optional, speeds up future uses
            this.Render = function (model) {
                return Mustache.render(template, model);
            }
        }

        var trackItemView = new View('track');



        var socket = io.connect('http://192.168.1.11:8080/');
        var transportClick = function (e) {
            console.log(e);
            socket.emit('transport', e.target.dataset);
        }
        var CTRLS = {
            PLAY: 'PLAY',
            PAUSE: 'PAUSE',
            STOP: 'STOP',
            STOPAFTER: 'STOPAFTER'
        }

        var Playlist = function (element) {
            var _this = this;
            this.El = element;
            this.Items = [];
            this.Fill = function (playlist) {
                while (this.Items.length > 0) this.Items.pop();
                var max = playlist.length;
                for (var i = 0; i < max; i += 1) {
                    this.Items.push(playlist[i]);
                }
            }
            this.GetElement = function (track) {
                var id = track.id;
                var el = $('<li />', { 'class': 'list-group-item', 'data-id': track.id });

                var buttonDelete = $('<button />', { 'class': 'btn btn-default glyphicon glyphicon-trash' });
                buttonDelete.on('click', function () {
                    var _id = id;
                    var _el = el;
                    _el.remove();
                    _this.Update();
                });
                var buttonPlay = $('<button />', { 'class': 'btn btn-success transport-control', 'data-id': track.id, 'data-type': CTRLS.PLAY });

                buttonPlay.append($('<span />', { 'class': 'glyphicon glyphicon-play' }));

                buttonPlay.on('click', transportClick);

                el.append($('<span />').html(track.title))
                           .append(buttonPlay);
                el.append(buttonDelete);
                return el;
            }
            this.NowPlaying = function (id) {
                this.El.find('li').removeClass('now-playing').each(function (i, item) {
                    if ($(item).attr('data-id') === id) $(item).addClass('now-playing');
                });
            }

            this.Draw = function (tracks) {
                this.El.empty();
                var max = this.Items.length;
                for (var i = 0; i < max; i += 1) {
                    // this.El.append(this.GetElement(tracks[this.Items[i]]));
                    this.El.append(trackItemView.Render(tracks[this.Items[i]]));
                }
            }
            this.Sync = function () {
                console.log(this, _this);
                socket.emit('playlist:sync', _this.Items);
            }
            this.Update = function () {
                // update playlist from view
                throw "Not IMplimented";
            }
        }

        var Tracks = function () {
            this.Items = {};
            this.Fill = function (data) {
                for (var key in data) {
                    this.Items[key] = data[key];
                }
            }
            this.FillFromArray = function (arr) {
                var max = arr.length;
                for (var i = 0; i < max; i += 1) {
                    this.Items[arr[i].id] = arr[i];
                }
            }
            this.GetElement = function (track) {
                return $('<li />', { 'data-id': track.id, 'class': 'sortable list-group-item' })
                            .text(track.title);
            }
            this.Draw = function (element, result) {
                var max = result.length;
                element.empty();
                for (var i = 0; i < max; i += 1) {
                    element.append(trackItemView.Render(result[i]));
                    //element.append(this.GetElement(result[i]));
                }
            }
        };
        var playlist = new Playlist($('#playlist'));
        var tracks = new Tracks();

        var syncRequest$ = new Rx.Subject();
        syncRequest$.throttle(2000).subscribe(playlist.Sync);

        var searchRequest$ = Rx.Observable.fromEvent($('#txtSearch'), 'input')
				.map(function (e) { return e.target.value; })
				.filter(function (e) { return e.length > 2; })
				.throttle(300);
        var transport$ = Rx.Observable.fromEvent($('.transport-control'), 'click');

        var sortables = [];


        transport$.subscribe(transportClick);
        socket.on('transport:now-playing', function (track) {
            $('#now-playing').text(track.title + ' by ' + track.artist[0]);
            playlist.NowPlaying(track.id);
        });

        $('ul.tracks').each(function (index, item) {
            var sortable = new Sortable(item, {
                group: {
                    name: 'sortable',
                    pull: 'clone',
                    put: false
                }
            });
            sortables.push(sortable);
        });

        $('ul.playlist').each(function (index, item) {
            var sortable = new Sortable(item, {
                group: 'sortable',
                //handle: '.drag-handle',
                onAdd: function (evt) {
                    var _playlist = [];
                    $('ul.playlist li').each(function (index, item) {
                        _playlist.push(item.dataset.id);
                    });

                    playlist.Fill(_playlist);
                    syncRequest$.onNext(true);
                },
                onUpdate: function () {
                    var _playlist = [];
                    $('ul.playlist li').each(function (index, item) {
                        _playlist.push(item.dataset.id);
                    });

                    playlist.Fill(_playlist);
                    syncRequest$.onNext(true);
                }
            });
            console.log(sortable);
            sortables.push(sortable);
        });


        searchRequest$.subscribe(function (value) {
            socket.emit('search:query', ['title', value]);
        });

        socket.on('playlist:load', function (data) {
            tracks.Fill(data.Tracks);
            playlist.Fill(data.Playlist);
            playlist.Draw(tracks.Items);
        });

        socket.on('search:result', function (data) {
            tracks.Draw($('#tracks'), data.result);
            tracks.FillFromArray(data.result);
        });

    </script>
</body>
</html>